{% extends "base.html" %}
{% block title %}Danh sách công việc{% endblock %}
{% block content %}
<h2 class="mb-4">Dashboard - Danh sách công việc</h2>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th scope="col">STT</th>
        <th scope="col">Tên công việc</th>
        <th scope="col">Đơn vị gửi</th>
        <th scope="col">Người nhận</th>
        <th scope="col">Thời gian trả</th>
        <th scope="col" class="text-center">Đã nhận</th>
        <th scope="col" class="text-center">Hoàn thành</th>
        <th scope="col" class="text-center">Hành động</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr>
        <th scope="row">{{ forloop.counter }}</th>
        <td>{{ task.ten_cong_viec }}</td>
        <td>{{ task.don_vi_gui }}</td>
        <td>{{ task.nguoi_nhan.username }}</td>
        <td>{{ task.thoi_gian_tra|date:"H:i d/m/Y" }}</td>

        <td class="text-center">
          {% if task.da_nhan %}
          <span class="text-success small fw-bold">Đã nhận</span>
          {% if task.ngay_nhan %}<br /><small>{{ task.ngay_nhan|date:"H:i d/m/Y" }}</small>{% endif %}<br />
          {% endif %}
          {% if task.nguoi_nhan == user %}
          <form
            method="POST"
            action="{% url 'task_toggle_status' pk=task.pk status_field='da_nhan' %}"
            class="d-inline-block mt-1"
          >
            {% csrf_token %}
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                name="da_nhan"
                id="da_nhan_{{ task.pk }}"
                {%
                if
                task.da_nhan
                %}checked{%
                endif
                %}
                onchange="this.form.submit()"
              />
              <label class="form-check-label small" for="da_nhan_{{ task.pk }}">
                Cập nhật
              </label>
            </div>
          </form>
          {% endif %}
        </td>

        <td class="text-center">
          {% if task.hoan_thanh %}
          <span class="text-danger small fw-bold">Đã hoàn thành</span>
          {% if task.ngay_hoan_thanh %}<br /><small>{{ task.ngay_hoan_thanh|date:"H:i d/m/Y" }}</small>{% endif %}<br />
          {% endif %}
          {% if task.nguoi_nhan == user %}
          <form
            method="POST"
            action="{% url 'task_toggle_status' pk=task.pk status_field='hoan_thanh' %}"
            class="d-inline-block mt-1"
          >
            {% csrf_token %}
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                name="hoan_thanh"
                id="hoan_thanh_{{ task.pk }}"
                {%
                if
                task.hoan_thanh
                %}checked{%
                endif
                %}
                {%
                if
                not
                task.da_nhan
                %}disabled{%
                endif
                %}
                onchange="this.form.submit()"
              />
              <label
                class="form-check-label small"
                for="hoan_thanh_{{ task.pk }}"
              >
                Cập nhật
              </label>
            </div>
          </form>
          {% endif %}
        </td>

        <td class="text-center">
          {% if user.is_staff %}
          <a
            href="{% url 'task_edit' pk=task.pk %}"
            class="btn btn-sm btn-primary me-1"
            >Sửa</a
          >
          <a
            href="{% url 'task_delete' pk=task.pk %}"
            class="btn btn-sm btn-danger"
            >Xóa</a
          >
          {% else %} - {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="text-center">
          <div class="alert alert-info my-3">
            {% if user.is_staff %} Chưa có công việc nào. Hãy thêm một công việc
            mới! {% else %} Bạn chưa được giao công việc nào. {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if user.is_staff %}
<a href="{% url 'task_add' %}" class="btn btn-success mt-3">
  + Thêm công việc mới
</a>
{% endif %}
{% endblock %}
